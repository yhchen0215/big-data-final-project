# Egg Price Estimation
## 計畫目標的問題 (Target problem)
前段時間，台灣的雞蛋產量過少，許多人為了吃顆蛋需要走遍三四間超市，在新聞上也大幅報導[1][2]。由於雞蛋供不應求，蛋價也隨之來的飆升，我們也對此現象現象深感困擾，因此希望對此問題深入研究，期望可以提早預測未來的蛋價走向。

在進行研究前，我們會先收集可能影響台灣蛋價因素的相關資料，希望在此研究中可以找到影響蛋價浮動的原因，並且在了解原因後，以深度學習的模型進行未來蛋價的預測，藉此可以盡早做出因應措施，避免再次出現雞蛋飆高或供不應求的現象。

## 選用的資料集描述與觀察 (Descriptions of selected datasets, including the characteristics in terms of Big Data)
我們收集的資料包含：雞蛋價格、飼料價格、蛋雞數量、天氣資訊、禽流感資料、以及Covid19疫情資料。而以下會針對每份資料做詳細的說明：

#### 雞蛋價格
- 描述：取自農委會的公開資料<家禽交易行情>，欄位包含肉雞價格及雞蛋價格，此處我們取雞蛋價格作為模型的預測目標。
- 資料數量：4178筆 (2010/10/07 ~ 2022/03/21) 
- 資料欄位：`日期` `農曆` `白肉雞(2.0Kg以上)` `白肉雞(1.75-1.95Kg)` `白肉雞(門市價高屏)` `雞蛋(產地)`

#### 飼料價格
- 描述：取自農委會的公開資料<飼料價格>，欄位包含常見的玉米、米糠、魚粉等。因為本研究的主題為雞蛋相關，此處我們移除不需要的豬飼料價格。
- 資料數量：313筆 (1998/01 ~ 2022/02)
- 資料範例：`日期` `玉米粒` `米糠` `麩皮` `黃豆粉` `魚粉` `蛋雞飼料`

#### 蛋雞數量
- 描述：取自中央畜產會的資料<家禽飼養隻數>，欄位包含雛雞隻數、產蛋隻數、產蛋數量等。
- 資料數量：134筆 (2011/01~2022/03)
- 資料範例：`年份` `月份` `入中雞雛數` `產蛋隻數` `均日產蛋箱數` `年產蛋數` `淘汰隻數` `目前換羽隻數`

#### 天氣資訊
- 描述：由於中央氣象局沒有直接提供每日的氣象資料，僅有一個使用爬蟲爬下來的資料集，但該資料在使用上不是那麼方便，所以我們最後選取的是農業氣象觀測網監測系統提供的資料，在此網站上我們抓取不同測站的氣溫及雨量資料。
- 資料數量：8115筆 (2000/01/01~2022/4/11)
- 資料範例：`觀測時間` `平均氣溫(℃)` `最高氣溫(℃)` `最低氣溫(℃)` `累計雨量(mm)` `累積日照時數(hr)`

#### 禽流感資料
- 描述：資料來自禽流感資訊展示頁面，此處只有撲殺量一個欄位的資料。
- 資料數量：87筆 (2015/01~2021/12)
- 資料範例：`年份` `月份` `撲殺量`

#### Covid19疫情資料
- 描述：資料來自Our World in Data，我們從中取出台灣的疫情資訊。
- 資料數量：789筆 (2020/01/18 ~ 2022/03/13)
- 資料範例：`date` `total_cases` `new_cases` `new_cases_smoothed` `total_deaths` `new_deaths` `new_deaths_smoothed` `positive_rate`

## 分析流程 (Analysis workflow)
為了預測蛋價，我們將問題分析的流程分成三個階段，分別是資料前處理、特徵選取及模型訓練。

### 資料前處理 (Data preprocessing)
由於資料集的來源不同，時間欄位的表示法會隨著不同資料集而有所不同。此外，每個資料及涵括的時間區間也不盡相同，需要經過前處理將資料整理成統一的格式，利用課堂所學我們在這個階段的處理中使用 Pyspark做為處理資料的工具。

**Step1** 資料集分類：將資料集分成以日/月為單位兩種，分別做處理。
**Step2** 缺失值補齊：將資料中含有缺失值的部分，以前一筆非空資料為準補值。
**Step3** 時間格式、欄位名稱統一：將時間統一格式為「年+月」、「日」兩個欄位，並以統一的格式重新命名所有欄位。
**Step4** 資料合併：將所有資料以時間為準對齊，並合併為一個完整的資料集。

### 特徵選取 (Feature selection)
在收集來的資料中，有部分的欄位與我們的題目相關性不高（如：飼料價格中的大中小豬飼料價格），我們將這些欄位移除。除此之外，我們選擇拿掉禽流感及Covid19疫情資料，前者是因為其資料筆數過少（僅有87筆），且其欄位只有撲殺的雞隻數，沒有辦法很好的反應禽流感疫情對蛋價的影響；後者則是因為疫情是從2020年開始，僅收集到最近三年的資料，相較於蛋價12年的時間長度佔不到1/4，若將前面的數值全以0補值會造成模型訓練上的偏差，因此我們選擇將其去除。

經過篩選過後，我們最後選擇的資料集包含：蛋價、飼料價格、家禽產量及天氣資訊，並將這些資料經過縮放後作為模型訓練用的特徵。

### 模型訓練
由於我們將這個題目定義為時序預測 (sequence prediction) 的問題，所以除了使用基本的DNN架構做為比較基準以外，我們挑選的模型是近年來在處理這類問題的佼佼者。以下簡單介紹我們使用的幾個模型：
- DNN：最基本的深層神經網路，將前一天的特徵值經過一個多層的神經網路後得到新的預測值，取此預測值與實際值計算均方誤差，再將這個誤差值反向傳遞更新整個網路的權重，重複此過程來得到訓練好的模型。
- LSTM：為了處理RNN架構中梯度消失及梯度爆炸問題所提出的模型，其架構設計可經由控制不同閘門來調控記憶/遺忘前面序列特徵的比例。
- GRU：LSTM的改良版本，更動了部分LSTM模組中閘門的設計來加快運算速度並降低記憶體的使用率。
- Transformer：近年來處理時序問題中最知名的模型之一，其自注意機制的設計可以很好的捕捉序列中元素的交互關係。

### 分析結果 (Analysis results)
在實驗設計中，我們將資料以時間先後排序，以85:15去做切分，分別做為訓練用以及測試用的資料。並將實驗分為三個階段：

**Step1** 先以前30天的資料作為特徵去預測一天過後的蛋價。
**Step2** 利用前30天的資料作為特徵去預測W天後的蛋價。
**Step3** 分別是以前T天的資料作為特徵去預測一個禮拜後的蛋價。

在以上三個階段中，我們會將前面介紹的幾個模型分別實驗，並且記錄在不同的實驗設置下測試資料所得到的MAPE/MSE/MAE。

- **利用前30天的資料預估一天後的蛋價**
在第一項實驗中，我們用不同的模型去對這份資料集做訓練及測試，希望可以看出哪一項模型會有最好的表現，也同時可以看出這份資料目前可以預測到的最佳的精確度，其表現結果如下:
![](https://i.imgur.com/Zg7WT2w.png)
![](https://i.imgur.com/VgWT6RM.png)
![](https://i.imgur.com/Y5y6Nv6.png)

    從上表和圖一到圖六可以看出，DNN的表現結果最差，在測試資料中，DNN的MAPE與其他模型至少有著兩倍的差距，圖一中的蛋價預測折線也與真實蛋價折線有著明顯可見的差距，短期內的波動也相對巨大。這代表在蛋價預測的問題中，如果只考慮前一天的資訊作為評估的依據的話，是無法得到精確的預測結果的。而出乎意料地，Transformer的表現並不如我們原本預期的好，從MSE和MAE兩個評估結果來看，他與前面三名的差距仍有相當的差距，猜測原因是在蛋價預測的問題中，我們取得的資料集並沒有這麼高的長期依賴性，所以Transformer無法發揮他的長處。

    而Bi-LSTM與Bi-GRU的表現結果則是都十分優異，兩者的MAPE更是分別來到了0.03與0.02，Bi-GRU看起來比Bi-LSTM好了一些些，而在圖二與圖四中則可以更加清楚的看到，整體來說Bi-GRU的蛋價預測折線會更加地貼近真實蛋價折線，這也表明在蛋價預測的問題上，Bi-GRU這項模型會更加的適合。除此之外，我們也在這兩個模型上加上了attention進行測試，從表一的結果可以看到，Bi-LSTM在加了attention後結果變差了、相反的Bi-GRU則是得到了更好的預測表現，而Bi-GRU+Attention也正是我們這項實驗中可以得到最好的預測蛋價的模型。
    
- **查看前30天的資料對w天後蛋價做預測**
由於雞蛋市場價格的波動在短期內其實並不大、甚至不會有所變化，加上當下發生的變化可能對蛋價的影響有所延遲。所以我們想測試，如果把預測的日期放到7天、14天、甚至是21天後，我們的模型是否仍舊可以依據當前所擁有的資訊去預測未來的蛋價，其表現結果如下:
![](https://i.imgur.com/zZY2yvJ.png)

    根據上表的實驗結果，在拉長預測日期(W)到21天的過程中，除了DNN和Bi-LSTM+attention外，其他的模型都是隨著預測日期的增加，精準度會逐漸地下降，符合我們日常生活中的經驗，距離當前時間越久後的蛋價會越難以去預測。除此之外，在預測日期等於21的資料中我們也可以看到，原本在預測日期等於1時表現不錯的Bi-GRU在時間拉長後相對其他模型就沒那麼出色，而原先表現最佳的Bi-GRU+attention更是下降幅度遠遠大過其他模型。

    即使如此，我們在預測日期拉長後仍舊可以把MAPE維持在0.08以內，MAE更是在2.5以內，考慮到測試資料的變化幅度，我們認為這個結果仍就是不錯的，尤其是Bi-LSTM+attention在較長預測日期中的表現的更加出色。


- **查看前T天的資料預估一個禮拜後的蛋價**
由於我們是把不同的資料集內的資料直接作為特徵，查看的天數越多，模型用的特徵數就會越多，也可以獲得越多的資訊去作為評估的依據，因此在實驗中，我們有實作查看前1天、10天、30天、60天，其表現結果如下：
![](https://i.imgur.com/9uZ8zva.png)

    在表九中可以看到，並非查看越多天數的資料來作為特徵，模型的表現就會更好。相反地，在我們的結果中能看到，在某些模型中查看越多天反而結果會越差。但是從表中我們同時也可以看到，同樣是預估一個禮拜後的蛋價，Bi-LSTM和Bi-GRU在整體上的表現仍然是優於其他人的，但是兩者在加了attention後，結果則不一定會更好。

最後，在以上三個實驗中，我們利用多個DNN與RNN的模型，對我們收集到的資料做訓練與預測，在第一部分的實驗中雖然未做出當初預期的成果，但我們看到了在我們收集的資料集下，各個模型的表現差異，也找到了在這份資料集中相對適合的模型。除此之外，我們也分別對不同時間長度的資料特徵、不同天數後的蛋價逐次的測試，得到了豐富的實驗結果，這些實驗結果也有助於未來在面對蛋價的變動時，我們可以更先一步的去對未來市場價格做評估。

## 過程中遭遇的挑戰與討論 (Discussions)
在這個專題當中，我們從「蛋價」這個貼近生活的問題出發，試圖找出可能造成其價格波動的因素，並收集這些因素相關的資料集。從這些資料集中，我們利用資料分析的技巧及深度學習的知識，建構出用來預測未來蛋價的模型，，並且設計不同的實驗，來進一步了解資料集的特性，找出最適合這個問題的模型。

在資料收集的部分，最大的挑戰是要找到理想的資料並不容易，畢竟並不是所有領域都有將資料數位化並放在網路上公開。所以我們常需要從不同角度切入，看看不同的政府機關是否剛好有我們所需要的資料形式。而收集完後我們需要整理、並對這些可能的特徵做取捨，哪些特徵可能對我們的問題沒有幫助？而哪些資料在訓練上可能造成模型的問題？這些都是值得思考的問題。最後在模型訓練的部分，我們需要根據理論知識，分析特定模型表現不理想的原因，並試圖改善模型的預測準確度。

這個題目仍有許多可探索的空間，例如調整各模型的超參數，或是根據資料集的特性調整模型的架構等。除此之外，我們也可以針對特徵做分析，試著移除某些特徵後看看模型的表現會不會因此而下降，來找出真正影響蛋價的因素。雖然目前的成果離真正能預測蛋價仍有段距離，但這個案例仍讓人期待，大數據資料能真正應用在現實生活中，並改善生活體驗那一天的到來。

## 參考文獻 (Reference)
- [早餐店「加蛋一顆15塊」有感漲價！網捏荷包吐槽：銅板小確幸高級享受](https://www.ftvnews.com.tw/news/detail/2021C22W0118)
- [十年來最嚴重蛋荒，缺蛋問題怎麼解？【獨立特派員】](https://news.pts.org.tw/article/578578)
- [政府資料開放平臺](https://data.gov.tw/)
- [中央畜產會](https://www.naif.org.tw/infoFowlsListAll.aspx?frontTitleMenuID=37&frontMenuID=114)
- [農業氣象觀測網](https://agr.cwb.gov.tw/NAGR/history/station_day)
- [Covid19 by Our World in Data](https://github.com/owid/covid-19-data/tree/master/public/data/)
- [禽流感資訊專區](https://ai.gov.tw/ws.php?id=209)
